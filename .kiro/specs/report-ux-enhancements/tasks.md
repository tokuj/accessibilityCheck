# Implementation Plan: report-ux-enhancements

## Tasks

- [x] 1. レポート画面レイアウトの最適化
- [x] 1.1 (P) レポートコンテナの横幅を拡張する
  - カードコンポーネントの最大幅を900pxから1400pxに変更
  - レスポンシブブレークポイントでの表示を維持
  - 変更後、横スクロールが発生しないことを確認
  - _Requirements: 1.1, 1.3_

- [x] 1.2 (P) 違反テーブルのカラムレイアウトを最適化する
  - 8カラム（ツール、ページ、ルールID、説明、影響度、ノード数、WCAG項番、詳細）の幅調整
  - 説明カラムの最大幅制限を緩和
  - 狭い画面幅での可読性を維持するレスポンシブ対応
  - _Requirements: 1.2, 1.4_

---

- [x] 2. CSVダウンロード機能の実装
- [x] 2.1 (P) CSV生成ユーティリティを作成する
  - 違反データをCSV形式に変換するロジックを実装
  - UTF-8 BOM付きでエンコードし、Excel等での文字化けを防止
  - カンマ・改行・ダブルクォートを含むフィールドの適切なエスケープ処理
  - ファイル名に分析対象ドメインと日時を含める形式で生成
  - _Requirements: 2.3, 2.4, 2.5_

- [x] 2.2 違反テーブルにCSVダウンロードボタンを追加する
  - テーブル上部にダウンロードアイコン付きボタンを配置
  - ボタンクリック時にCSV生成ユーティリティを呼び出し
  - Blob + URL.createObjectURLでブラウザダウンロードを実行
  - 違反が0件の場合はボタンを非活性化
  - _Requirements: 2.1, 2.2_

---

- [x] 3. AI総評機能の実装（Gemini Flash統合）
- [x] 3.1 (P) Secret Managerサービスを作成する
  - GCP Secret Managerクライアントを初期化
  - 指定されたシークレット名からAPIキーを取得する関数を実装
  - Cloud Runではサービスアカウント経由で自動認証
  - ローカル開発時は環境変数からのフォールバックを実装
  - 取得したキーをメモリにキャッシュして再利用
  - APIキーをログに出力しないセキュリティ対策
  - _Requirements: 3.1_

- [x] 3.2 (P) AccessibilityReport型にAI総評フィールドを追加する
  - フロントエンド・バックエンド両方の型定義を更新
  - AI総評の構造（評価、改善ポイント、推奨事項、影響度サマリー）を定義
  - 既存の型との後方互換性を維持（オプショナルフィールド）
  - _Requirements: 3.3_

- [x] 3.3 Gemini APIクライアントサービスを作成する
  - Secret Managerから取得したAPIキーでGemini 3 Flashを呼び出す
  - 違反情報とスコアからAI総評を生成するプロンプトを構築
  - 日本語で総評を生成するようプロンプトを設計
  - 構造化された総評（評価、優先改善点、推奨事項、サマリー）を返却
  - タイムアウト処理とレート制限対応を実装
  - _Requirements: 3.2, 3.5_

- [x] 3.4 分析フローにAI総評生成を統合する
  - 分析完了後にGeminiサービスを呼び出してAI総評を生成
  - API呼び出し失敗時は既存のルールベース総評にフォールバック
  - エラーをログに記録し、ユーザーには影響を与えない設計
  - レスポンスにAI総評を含めて返却
  - _Requirements: 3.2, 3.4_

- [x] 3.5 フロントエンドでAI総評を表示する
  - 改善リストコンポーネントにAI総評セクションを追加
  - AI総評とルールベース総評を適切に切り替えて表示
  - AI総評生成中のローディング状態を表示
  - 総評の各セクション（評価、改善点、推奨事項）を視覚的に分離
  - _Requirements: 3.3, 3.6_

---

- [x] 4. 分析中のリアルタイムログ表示機能の実装
- [x] 4.1 (P) SSEイベント型を定義する
  - ログ、進捗、違反検出、完了、エラーの各イベント型を定義
  - フロントエンド・バックエンドで共有する型として設計
  - 既存の型定義ファイルに追加
  - _Requirements: 4.3_

- [x] 4.2 SSEストリーミングエンドポイントを作成する
  - 新規エンドポイント `/api/analyze-stream` を追加
  - SSE用のHTTPヘッダー（Content-Type, Cache-Control, Connection）を設定
  - 分析実行中に進捗コールバックを受け取りSSEイベントとして送信
  - 分析完了時にレポートを送信して接続を終了
  - エラー発生時に適切なエラーイベントを送信
  - CORSヘッダーを明示的に設定
  - _Requirements: 4.2, 4.5_

- [x] 4.3 分析オーケストレータに進捗コールバックを追加する
  - analyzeUrl関数に進捗通知用コールバック引数を追加
  - 各ツール実行開始・完了時にコールバックを呼び出し
  - 違反検出時にルール名と影響度を通知
  - 既存のconsole.logをコールバック経由に統合
  - _Requirements: 4.2, 4.3_

- [x] 4.4 フロントエンドのログ表示UIを実装する
  - 分析中にリアルタイムログ表示エリアを表示
  - EventSource APIでSSEエンドポイントに接続
  - 受信したログメッセージをリストに追加表示
  - 自動スクロールで最新ログを表示
  - エラーメッセージを赤色でハイライト表示
  - 最大表示行数を制限してメモリ管理
  - _Requirements: 4.1, 4.3, 4.4, 4.6_

- [x] 4.5 分析フローをSSEベースに切り替える
  - フロントエンドのAPI呼び出しをSSEエンドポイントに変更
  - 完了イベント受信時にレポート画面に遷移
  - エラーイベント受信時に適切なエラー表示
  - 接続切断時の再接続ロジックを実装
  - 既存のPOSTエンドポイントは後方互換のため維持
  - _Requirements: 4.1, 4.5_

---

- [ ] 5. 統合テストと動作確認
- [ ] 5.1 レイアウトとCSV機能の動作確認を行う
  - 各種画面幅でレポート画面の横スクロール発生有無を確認
  - CSVダウンロードが正常に動作することを確認
  - ダウンロードしたCSVがExcel等で正しく開けることを確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 5.2 AI総評機能の動作確認を行う
  - 分析実行後にAI総評が生成されることを確認
  - AI総評の内容が要件を満たしていることを確認
  - API失敗時にフォールバックが機能することを確認
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

- [ ] 5.3 ログストリーミング機能の動作確認を行う
  - 分析中にリアルタイムでログが表示されることを確認
  - 進捗状況が正しく表示されることを確認
  - 完了時に結果画面に遷移することを確認
  - エラー時に赤色ハイライトで表示されることを確認
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 1.1 |
| 1.2 | 1.2, 5.1 |
| 1.3 | 1.1, 5.1 |
| 1.4 | 1.2, 5.1 |
| 2.1 | 2.2, 5.1 |
| 2.2 | 2.2, 5.1 |
| 2.3 | 2.1, 5.1 |
| 2.4 | 2.1, 5.1 |
| 2.5 | 2.1, 5.1 |
| 3.1 | 3.1, 5.2 |
| 3.2 | 3.3, 3.4, 5.2 |
| 3.3 | 3.2, 3.5, 5.2 |
| 3.4 | 3.4, 5.2 |
| 3.5 | 3.3, 5.2 |
| 3.6 | 3.5, 5.2 |
| 4.1 | 4.4, 4.5, 5.3 |
| 4.2 | 4.2, 4.3, 5.3 |
| 4.3 | 4.1, 4.3, 4.4, 5.3 |
| 4.4 | 4.4, 5.3 |
| 4.5 | 4.2, 4.5, 5.3 |
| 4.6 | 4.4, 5.3 |

---

_Generated at: 2025-12-20T10:55:00+09:00_
_Updated at: 2025-12-20T23:32:00+09:00_
