# Implementation Plan

## Task 1: AI総評CSV出力機能

- [x] 1.1 (P) AI総評をCSV形式に変換する機能を実装
  - 検出された問題の配列を受け取り、問題番号・何が起きているか・修正に必要なもの・どう修正するかの4カラムでCSVを生成
  - 既存のエスケープ処理を再利用してカンマ・改行・ダブルクォートを適切に処理
  - UTF-8 BOM付きで出力しExcel互換を確保
  - 空配列の場合はヘッダーのみのCSVを返却
  - _Requirements: 1.2, 1.3_

- [x] 1.2 (P) AI総評CSV用のファイル名生成機能を実装
  - 分析対象URLからドメインを抽出し、日付と組み合わせてファイル名を生成
  - ファイル名形式: `ai-summary_{domain}_{YYYY-MM-DD}.csv`
  - URLパースエラー時はフォールバック名を使用
  - _Requirements: 1.6_

- [x] 1.3 AI総評CSVダウンロード関数を実装
  - CSV生成とファイル名生成を組み合わせてBlobを作成
  - aタグ経由でダウンロードをトリガー
  - ダウンロード後にBlob URLを解放
  - _Requirements: 1.1_
  - _Contracts: csvExport Service Interface_

- [x] 1.4 AI総評CSV機能の単体テストを追加
  - 空配列、複数件、特殊文字を含むケースでCSVコンテンツ生成をテスト
  - 様々なURLパターンでファイル名生成をテスト
  - BOMが正しく付与されていることを検証
  - _Requirements: 1.2, 1.3, 1.6_

## Task 2: PDF出力機能の基盤

- [x] 2.1 html2pdf.jsをプロジェクトに追加
  - frontendディレクトリにhtml2pdf.jsパッケージをインストール
  - TypeScript型定義の設定（必要に応じて型宣言ファイルを作成）
  - _Requirements: 2.1_

- [x] 2.2 (P) PDF用ファイル名生成機能を実装
  - 分析対象URLからドメインを抽出し、日付と組み合わせてファイル名を生成
  - ファイル名形式: `a11y-report_{domain}_{YYYY-MM-DD}.pdf`
  - URLパースエラー時はフォールバック名を使用
  - _Requirements: 2.6_

- [x] 2.3 レポートをPDF形式でエクスポートする機能を実装
  - DOM要素を受け取り、html2pdf.jsでPDFに変換
  - 背景色を白に設定して印刷向けスタイルを適用
  - 高解像度出力（scale: 2）でテキストの鮮明さを確保
  - 成功・失敗を示す結果オブジェクトを返却
  - _Requirements: 2.1, 2.2, 2.3_
  - _Contracts: pdfExport Service Interface_

- [x] 2.4 PDF生成機能の単体テストを追加
  - 様々なURLパターンでファイル名生成をテスト
  - エラーケース（無効な要素参照）のハンドリングをテスト
  - _Requirements: 2.6_

## Task 3: ダウンロード状態管理フック

- [x] 3.1 ダウンロード処理の状態管理カスタムフックを実装
  - ダウンロード中フラグとエラー状態を管理
  - AI総評CSVダウンロード関数をラップして状態を更新
  - PDFダウンロード関数をラップして非同期状態を管理
  - 同時に複数ダウンロードを防止するガード処理
  - _Requirements: 2.4_
  - _Contracts: useDownload State Management_

- [x] 3.2 Snackbar通知の状態管理を実装
  - ダウンロード成功時にメッセージと成功アイコンを表示
  - エラー発生時にメッセージとエラーアイコンを表示
  - PDF生成失敗時に再試行ボタンを含むアクションを提供
  - ブラウザがダウンロードをブロックした場合のガイダンスを表示
  - _Requirements: 2.5, 3.2, 3.4_

## Task 4: UI統合 - AI総評CSVダウンロードボタン

- [x] 4.1 AI総評セクションにCSVダウンロードボタンを追加
  - AI総評ヘッダー右側（タイトルとGemini Flashチップの右隣）にボタンを配置
  - 既存の詳細結果CSVボタンと統一されたアイコンとスタイルを使用
  - AI総評データが存在しないか検出問題が空の場合はボタンを非活性化
  - ボタンクリックでダウンロードフック経由でCSV出力を実行
  - _Requirements: 1.1, 1.4, 1.5, 3.1_

- [x] 4.2 AI総評CSVダウンロードの統合テストを追加
  - ボタンクリックからCSVダウンロード開始までの動作を検証
  - AI総評データ未存在時のボタン非活性状態を検証
  - 成功通知の表示を検証
  - _Requirements: 1.1, 1.4, 3.2_

## Task 5: UI統合 - レポートPDFダウンロードボタン

- [x] 5.1 レポートコンポーネントにPDF対象領域のref設定を追加
  - カードコンテンツ全体を参照するrefを設定
  - PDFに含めたい要素がref内に収まるよう構成を確認
  - 装飾的な背景要素がref外またはPDF生成時に除外されるよう調整
  - _Requirements: 2.2_

- [x] 5.2 レポートヘッダーにPDFダウンロードボタンを追加
  - ヘッダー右側の閉じるボタン左隣にボタンを配置
  - PDFであることを示すアイコンを使用
  - 他のダウンロードボタンと統一されたスタイルを適用
  - _Requirements: 2.1, 2.7, 3.1_

- [x] 5.3 PDF生成中の進捗インジケーターを実装
  - ダウンロード中フラグに基づいてボタン内にローディング表示
  - 生成中はボタンを非活性化して重複クリックを防止
  - _Requirements: 2.4_

- [x] 5.4 PDF生成のエラーハンドリングと再試行機能を実装
  - PDF生成失敗時にSnackbarでエラーメッセージを表示
  - 再試行ボタンを含むアクションを提供
  - 再試行クリックで同じ要素のPDF生成を再実行
  - _Requirements: 2.5_

- [x] 5.5 レポートPDFダウンロードの統合テストを追加
  - ボタンクリックからPDF生成開始までの動作を検証
  - 進捗インジケーターの表示を検証
  - 成功通知の表示を検証
  - エラー時の再試行ボタン動作を検証
  - _Requirements: 2.1, 2.4, 2.5, 3.2_

## Task 6: Snackbar通知コンポーネントの統合

- [x] 6.1 ダウンロード通知用Snackbarをレポート画面に統合
  - ダウンロードフックから提供されるSnackbar propsを使用
  - MUIのSnackbarとAlertコンポーネントを組み合わせて表示
  - 成功・エラーに応じた色分けとアイコンを適用
  - 自動閉じ時間を設定（成功は短く、エラーは長めに）
  - _Requirements: 3.2, 3.4_

## Task 7: モバイル対応とクロスブラウザ検証

- [x] 7.1 モバイルブラウザでのダウンロード動作確認とE2Eテスト
  - iOSとAndroidのブラウザでCSVダウンロードが動作することを確認
  - iOSとAndroidのブラウザでPDFダウンロードが動作することを確認
  - Blob URL方式のモバイル互換性を検証
  - Safari用にURL解放タイミングを調整（必要に応じて）
  - _Requirements: 3.3_
