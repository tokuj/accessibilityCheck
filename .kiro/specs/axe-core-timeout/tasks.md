# Implementation Plan

## Task Overview

広告要素が多いWebサイトでのアクセシビリティテストのタイムアウト問題を解決するため、axe-core、Pa11y、Lighthouseの3つのツール全てに対してタイムアウト設定と広告除外機能を実装する。

## Tasks

- [x] 1. 共通設定モジュールの作成
- [x] 1.1 (P) 広告除外設定の定義
  - 広告関連CSSセレクタのデフォルトリストを定義する
  - 広告関連URLパターンのデフォルトリストを定義する
  - メディアファイル拡張子のブロックリストを定義する
  - 環境変数`DISABLE_AD_BLOCKING`による無効化ロジックを実装する
  - 設定のイミュータブル性を確保する
  - _Requirements: 4.1, 4.3_

- [x] 1.2 (P) タイムアウト設定の定義
  - ページ読み込み、axe-core、Pa11y、Lighthouseの各タイムアウト値を定義する
  - デフォルト値を設定する（ページ読み込み90秒、axe-core120秒、Pa11y90秒、Lighthouse90秒）
  - 環境変数による個別タイムアウト上書き機能を実装する
  - 型安全な設定取得関数を提供する
  - _Requirements: 4.2, 4.4_

- [x] 2. Playwrightリソースブロック機能の実装
- [x] 2.1 広告リクエストブロック機能の作成
  - Playwrightページに対して広告URLパターンへのリクエストをabortする機能を実装する
  - ブロックしたリクエスト数をカウントしログに記録する
  - ブロック対象パターンをログに出力する
  - メディアファイル（mp4、webm等）のブロックオプションを提供する
  - カスタムパターンの追加をサポートする
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 3. axe-core分析の最適化
- [x] 3.1 AxeBuilderオプションの拡張
  - `setLegacyMode(true)`をデフォルトで有効にする
  - 広告関連セレクタを`.exclude()`で除外する機能を追加する
  - `color-contrast`ルールの無効化オプションを提供する
  - オプション型を定義し、既存のシグネチャとの後方互換性を確保する
  - _Requirements: 1.1, 1.2, 1.3, 1.5_

- [x] 3.2 Playwrightタイムアウト設定の適用
  - ページ作成時に`page.setDefaultTimeout(120000)`を設定する
  - ページ読み込みタイムアウトを90秒に延長する
  - リソースブロック機能をページ作成直後に適用する
  - _Requirements: 1.4, 4.4_

- [x] 4. Pa11y分析の最適化
- [x] 4.1 Pa11yオプションの拡張
  - タイムアウトを90秒に設定する
  - 安定化待機時間を3秒に設定する
  - `hideElements`オプションで広告関連セレクタを非表示にする機能を追加する
  - デフォルトで広告要素除外を有効にする
  - オプション型を定義し、既存の認証オプションを継承する
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 5. Lighthouse分析の最適化
- [x] 5.1 Lighthouseオプションの拡張
  - `maxWaitForLoad`を90秒に設定する
  - `maxWaitForFcp`を60秒に設定する
  - `blockedUrlPatterns`で広告ドメインをブロックする機能を追加する
  - デフォルトで広告ブロックを有効にする
  - オプション型を定義し、既存の認証オプションを継承する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 6. エラーハンドリングとログ改善
- [x] 6.1 タイムアウトエラーの詳細化
  - タイムアウト発生箇所（ページ読み込み/axe-core/Pa11y/Lighthouse）を明示するエラーメッセージを実装する
  - 対象URL、ツール名、経過時間を含む構造化ログを出力する
  - _Requirements: 7.1, 7.4_

- [x] 6.2 分析時間のログ記録
  - 各ツールの分析開始時刻と終了時刻をログに記録する
  - 60秒超過時に警告ログを出力する
  - _Requirements: 7.2, 7.3_

- [x] 7. オーケストレーション層の更新
- [x] 7.1 analyzer.tsへの設定統合
  - 共通設定モジュールから設定を読み込む
  - 各アナライザーに適切なオプションを渡す
  - リソースブロック機能をaxe-core分析前に適用する
  - ページ読み込みタイムアウトを更新する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 5.1_

- [x] 8. CLIテスト設定の更新
- [x] 8.1 playwright.config.tsの更新
  - グローバルテストタイムアウトを180秒に設定する
  - アクションタイムアウトを90秒に設定する
  - _Requirements: 6.1, 6.2_

- [x] 8.2 accessibility.spec.tsの更新
  - ページ読み込み戦略を`domcontentloaded`に変更し、追加で2秒の安定化待機を行う
  - `setLegacyMode(true)`と広告要素除外を適用する
  - _Requirements: 6.3, 6.4_

- [x] 9. 統合テスト
- [x] 9.1 設定モジュールのテスト
  - デフォルト値の検証
  - 環境変数による上書きの検証
  - 広告ブロック無効化の検証
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 9.2 リソースブロック機能のテスト
  - 広告URLのブロック検証
  - ブロックカウントのログ出力検証
  - メディアファイルブロックオプションの検証
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 9.3 各アナライザーのテスト
  - axe-coreのlegacyModeと除外設定の検証
  - Pa11yのhideElements設定の検証
  - LighthouseのblockedUrlPatterns設定の検証
  - タイムアウト設定の検証
  - _Requirements: 1.1, 1.2, 2.1, 2.3, 3.1, 3.3_

- [x] 9.4 E2Eテスト
  - 広告が多いサイトでの分析完了を検証する
  - タイムアウトエラーメッセージの検証
  - _Requirements: 7.1, 7.4_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1, 1.2, 1.3, 1.5 | 3.1 |
| 1.4 | 3.2 |
| 2.1, 2.2, 2.3, 2.4 | 4.1 |
| 3.1, 3.2, 3.3, 3.4 | 5.1 |
| 4.1, 4.3 | 1.1, 7.1, 9.1 |
| 4.2, 4.4 | 1.2, 3.2, 7.1 |
| 5.1, 5.2, 5.3, 5.4 | 2.1, 7.1, 9.2 |
| 6.1, 6.2 | 8.1 |
| 6.3, 6.4 | 8.2 |
| 7.1, 7.4 | 6.1, 9.4 |
| 7.2, 7.3 | 6.2 |
