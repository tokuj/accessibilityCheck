# Requirements Document

## Introduction

現行のアクセシビリティ検証ツールでは、ユーザーが認証情報（Basic認証ヘッダー、セッションCookie、認証トークン等）を手動で調査し、ツールに渡す必要がある。これはセキュリティ上のリスク（認証情報の露出）とUXの問題（煩雑な手動作業）を引き起こしている。

本仕様では、ユーザーが直接ブラウザ上で認証を行い、その認証状態を自動的にキャプチャしてアクセシビリティ検証に活用できるUXを実現する。Playwright/Cypressなどの現代的なテストツールで採用されている「ストレージステート」パターンを適用し、セキュアかつ直感的な認証フローを提供する。

## Requirements

### Requirement 1: インタラクティブログイン記録

**Objective:** As a ユーザー, I want ブラウザ上で通常通りログインするだけで認証情報が自動記録される, so that 手動で認証情報を調査・入力する手間とセキュリティリスクを排除できる

#### Acceptance Criteria

1. When ユーザーが「ログイン記録」ボタンをクリックした場合, the 認証モジュール shall 計装されたブラウザウィンドウを起動し、指定されたログインURLを開く
2. When ブラウザウィンドウが開いた場合, the システム shall 「このウィンドウでログインしてください」というガイダンスバナーを表示する
3. When ユーザーがログイン完了後「ログイン完了」ボタンをクリックした場合, the 認証モジュール shall 現在のセッション状態（Cookie、localStorage、sessionStorage）をキャプチャする
4. When セッション状態のキャプチャが完了した場合, the 認証モジュール shall キャプチャしたデータを暗号化してストレージステートファイルとして保存する
5. The 認証モジュール shall 生のパスワードやクレデンシャルを一切保存しない（認証後のトークン・Cookieのみを保存する）

### Requirement 2: セッション再利用による検証

**Objective:** As a ユーザー, I want 一度記録した認証状態を再利用してアクセシビリティ検証を実行したい, so that 毎回ログインすることなく認証済みページを検証できる

#### Acceptance Criteria

1. When 保存済みのストレージステートファイルを選択して検証を開始した場合, the 検証エンジン shall ストレージステートを復号化してブラウザコンテキストに読み込む
2. When ストレージステートが正常に読み込まれた場合, the 検証エンジン shall 認証済み状態で対象ページにアクセスしてアクセシビリティ検証を実行する
3. If ストレージステートの復号化に失敗した場合, then the システム shall エラーメッセージを表示し、再ログインを促す
4. While 検証実行中に401/403エラーが発生した場合, the システム shall 「セッション期限切れ - 再ログインしますか？」という確認ダイアログを表示する
5. When ユーザーが再ログインを選択した場合, the 認証モジュール shall 同じ一時プロファイルでブラウザを再起動し、MFAループを回避する

### Requirement 3: 複数認証方式のサポート

**Objective:** As a ユーザー, I want Basic認証、フォーム認証、OAuth/SSOなど様々な認証方式に対応したい, so that どのような認証を使用するサイトでもアクセシビリティ検証が可能になる

#### Acceptance Criteria

1. When ユーザーがBasic認証を選択した場合, the 認証モジュール shall ユーザー名とパスワードの入力ダイアログを表示し、メモリ内でのみ保持する
2. When Basic認証情報が入力された場合, the 認証モジュール shall リクエストインターセプトフックを使用してAuthorizationヘッダーを注入する
3. When ユーザーがフォーム認証（Cookie/セッションベース）を選択した場合, the 認証モジュール shall 「ログイン記録」パターンを使用してインタラクティブログインを実行する
4. When ユーザーがOAuth/OIDC認証を選択した場合, the 認証モジュール shall システムブラウザで認証フローを開始し、ローカルHTTPリスナー（localhost callback）でトークンを受け取る
5. When 企業SSO（SAML、Azure AD等）が使用される場合, the 認証モジュール shall フロントチャネルリダイレクト後のセッションCookieをキャプチャする
6. The 認証モジュール shall OAuth/OIDCの場合、アクセストークンとリフレッシュトークンのみを保存し、ユーザーのパスワードは保存しない

### Requirement 4: セキュアなクレデンシャル管理

**Objective:** As a セキュリティ管理者, I want 認証情報が安全に管理されることを保証したい, so that セキュリティ監査要件を満たしつつユーザビリティを維持できる

#### Acceptance Criteria

1. The 認証モジュール shall ストレージステートファイルをAES-256で暗号化して保存する
2. The 認証モジュール shall 暗号化キーをOSキーチェーン（macOS Keychain、Windows DPAPI、Linux libsecret）から取得する
3. The 認証モジュール shall 自動化トラフィックをlocalhost経由のみで転送し、バックエンドサーバーには送信しない
4. Where 「自己破棄」オプションが有効な場合, the 認証モジュール shall テスト実行終了時にストレージステートファイルを自動削除する
5. When サービスアカウントによるスクリプト実行が必要な場合, the 認証モジュール shall 環境変数またはシークレットマネージャープラグインからシークレットを読み込む
6. The システム shall シークレットをブラウザを制御する子プロセスのメモリ内のみで保持する

### Requirement 5: セッションプリセット管理

**Objective:** As a チームメンバー, I want 複数の認証セッション（管理者、編集者、閲覧者など）を保存・切り替えたい, so that 異なる権限レベルでのアクセシビリティ検証を効率的に実行できる

#### Acceptance Criteria

1. When ユーザーがセッションを保存する場合, the システム shall セッション名（例：admin、editor、viewer）を指定して保存できる
2. The システム shall 保存済みセッション一覧をドロップダウンメニューで表示する
3. When セッションが選択された場合, the システム shall 対応するストレージステートファイルを読み込んで検証に使用する
4. The システム shall 各セッションの横にロックアイコンを表示し、ホバー時にドメイン、ユーザーID（検出可能な場合）、有効期限を表示する
5. When ユーザーがセッションを削除する場合, the システム shall 対応するストレージステートファイルを安全に削除する

### Requirement 6: セッションライフサイクル管理

**Objective:** As a ユーザー, I want セッションの有効期限管理と自動更新を行いたい, so that セッション期限切れによる検証中断を最小化できる

#### Acceptance Criteria

1. The 認証モジュール shall ストレージステートファイルにスキーマバージョンとタイムスタンプを含める
2. When OAuth/OIDCトークンにexpires_inフィールドが含まれる場合, the 認証モジュール shall 非表示タブでサイレントリフレッシュをスケジュールする
3. If トークンリフレッシュに失敗した場合, then the システム shall 単一のアクション可能なエラーメッセージを表示する
4. When 並列実行する場合, the システム shall マスターストレージファイルをワーカーごとの一時ファイルにコピーし、クロスコンタミネーションを防ぐ
5. When 検証完了後, the システム shall ブラウザコンテキストのCookieをクリアし、一時プロファイルを削除する

### Requirement 7: ユーザーインターフェース

**Objective:** As a ユーザー, I want 認証フローが直感的で分かりやすいUIで提供される, so that 技術的な知識がなくても認証済みページの検証ができる

#### Acceptance Criteria

1. The フロントエンド shall 「ログイン記録」のワンクリック開始ボタンを提供する
2. When ブラウザウィンドウが起動した場合, the システム shall ツールウィンドウを最小化し、ブラウザを前面に表示する
3. When ログインが正常に記録された場合, the システム shall 「ログイン記録完了 ✔ - 検証を続行できます」というトースト通知を表示する
4. The システム shall 現在の認証状態（未認証/認証済み/期限切れ）を視覚的に表示する
5. When 認証方式を選択する場合, the システム shall Basic認証、フォーム認証、OAuth/SSO、APIキーの選択肢を提供する
6. If セッションが期限切れの場合, then the システム shall 「再認証」ボタンを表示し、ワンクリックで再ログインフローを開始できる
