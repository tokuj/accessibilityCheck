# Implementation Plan

## Task 1: バックエンド - フォーム解析サービスの実装

- [x] 1.1 (P) フォーム解析の型定義を追加する
  - 解析結果を表す型（フィールド候補、信頼度スコア等）を定義する
  - 解析エラーの種別（タイムアウト、ナビゲーション失敗、フォーム未検出）を定義する
  - 解析オプション（タイムアウト時間等）の型を定義する
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 1.2 フォーム要素検出ロジックを実装する
  - Playwrightでheadlessブラウザを起動し、指定URLにアクセスする機能を実装する
  - ユーザー名入力フィールドをヒューリスティックで検出する（`input[type="email"]`, `input[name*="user"]`等）
  - パスワード入力フィールドを検出する（`input[type="password"]`）
  - 送信ボタンを検出する（`button[type="submit"]`, `input[type="submit"]`等）
  - 各検出要素に信頼度スコアを付与する
  - ブラウザインスタンスを処理完了後に確実にクローズする
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 1.3 解析サービスのエラーハンドリングを実装する
  - ページアクセス失敗時のエラー処理を実装する
  - タイムアウト発生時のエラー処理を実装する（デフォルト30秒）
  - フォーム要素が検出できない場合のエラー処理を実装する
  - _Requirements: 2.6, 5.3, 5.4_

- [x] 1.4 フォーム解析サービスのユニットテストを作成する
  - 正常系：各フォーム要素検出パターンのテスト
  - 異常系：タイムアウト、ナビゲーション失敗、フォーム未検出のテスト
  - ブラウザクローズが確実に行われることのテスト
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.6_

## Task 2: バックエンド - フォーム解析APIエンドポイントの実装

- [x] 2.1 解析APIエンドポイントを追加する
  - `POST /api/auth/analyze-form`エンドポイントをルーターに追加する
  - リクエストボディからURLを取得し、バリデーションを実行する
  - フォーム解析サービスを呼び出し、結果をJSONで返却する
  - エラー時は適切なHTTPステータスコード（400, 408, 500）を返却する
  - _Requirements: 2.1, 1.3, 1.4, 2.6, 5.3, 5.4_

- [x] 2.2 解析APIエンドポイントのインテグレーションテストを作成する
  - 正常系：有効なURLで解析結果が返却されることのテスト
  - 異常系：無効なURL、タイムアウト、サーバーエラーのテスト
  - _Requirements: 2.1, 1.3, 1.4_

## Task 3: フロントエンド - フォーム解析UIパネルの実装

- [ ] 3.1 (P) フロントエンドの型定義を追加する
  - 解析結果、フィールド候補、選択されたセレクタの型を定義する
  - 解析エラーの型を定義する
  - パネル状態管理用の型を定義する
  - _Requirements: 2.1, 3.1, 3.2, 3.3, 3.4_

- [ ] 3.2 フォーム解析API呼び出し関数を実装する
  - `POST /api/auth/analyze-form`を呼び出すAPI関数を追加する
  - 成功/失敗時の適切なエラーハンドリングを実装する
  - _Requirements: 2.1, 2.6, 5.3, 5.4_

- [ ] 3.3 フォーム解析パネルコンポーネントを実装する
  - ログインURL入力フィールドを実装する
  - URL形式バリデーションを実装し、無効な場合はエラーメッセージを表示する
  - 「解析」ボタンを実装する
  - 解析中のローディングインジケーターを表示する
  - _Requirements: 1.2, 1.3, 1.4, 2.1, 2.5_

- [ ] 3.4 解析結果表示機能を実装する
  - 検出されたフォーム要素（ユーザー名、パスワード、送信ボタン）を表示する
  - 各要素のセレクタ情報を表示する
  - フィールドタイプを明確に区別して表示する（アイコンやラベルで区別）
  - 複数候補がある場合は選択UIを表示し、ユーザーに選択させる
  - 解析失敗時はエラーメッセージを表示する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 2.6_

- [ ] 3.5 手動設定モード切り替え機能を実装する
  - 自動解析失敗時に手動設定モードへの切り替えオプションを表示する
  - タイムアウト時はリトライオプションを表示する
  - ネットワークエラー時はエラーメッセージを表示する
  - _Requirements: 5.1, 5.3, 5.4_

## Task 4: フロントエンド - AuthSettingsコンポーネントの拡張

- [ ] 4.1 フォーム解析パネルをAuthSettingsに統合する
  - フォームログイン選択時にフォーム解析パネルを表示する
  - 解析成功後、検出されたセレクタを認証設定に自動反映する
  - _Requirements: 1.1, 1.2_

- [ ] 4.2 簡易認証情報入力UIを実装する
  - 解析完了後はユーザー名入力欄とパスワード入力欄のみを表示する
  - パスワード入力欄はマスク表示する
  - セレクタ入力フィールドは非表示にする（自動設定済みのため）
  - 解析未完了時は認証情報入力欄を無効化する
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 4.3 手動設定モードへのフォールバックを実装する
  - 手動設定モード選択時は従来のセレクタ入力フィールドを表示する
  - 自動解析モードと手動設定モードを切り替え可能にする
  - _Requirements: 5.1, 5.2_

## Task 5: 統合テストとE2Eテスト

- [ ] 5.1 AuthSettings + FormAnalyzerPanel連携のインテグレーションテストを作成する
  - フォーム解析パネルがAuthSettingsで正しく表示されることのテスト
  - 解析結果がAuthConfigに反映されることのテスト
  - エラー状態が正しく表示されることのテスト
  - _Requirements: 1.1, 1.2, 2.1, 3.1, 4.1_

- [ ]* 5.2 E2Eテストを作成する
  - フォーム解析→認証情報入力→保存の完全フローのテスト
  - 解析失敗→手動設定モード切り替え→保存フローのテスト
  - 複数候補表示→選択→保存フローのテスト
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 5.4_
