# セッション管理機能 セキュリティ強化要件

## 概要

セッション管理機能のセキュリティを強化し、本番運用に適したレベルにする。o3によるセキュリティレビュー結果に基づく改善。

## 背景

現在の実装は基本的なセキュリティ要件を満たしているが、以下の改善が推奨されている：
- ブルートフォース攻撃への対策（レート制限）
- セッションの長期間放置への対策（有効期限強制）
- メモリ内の機密データ管理（鍵のゼロ化）
- GPU攻撃への耐性（Argon2id移行）

## 現在の実装

- 暗号化: AES-256-GCM
- 鍵導出: PBKDF2-SHA256（310,000反復）
- ソルト: 64バイトランダム
- IV: 12バイトランダム
- パスフレーズ: メモリ内のみ、保存なし

---

## 要件

### Phase 1: 必須改善（優先度: 高）

#### 1.1 レート制限
- 復号試行を1分あたり5回に制限する
- 失敗後は指数バックオフを適用する（1秒、2秒、4秒...）
- IPアドレス + ユーザーエージェント単位でグローバル制限を設ける

#### 1.2 セッション有効期限の強制
- セッションに最大有効期限（デフォルト30日）を設定する
- 「最終使用日時」を記録し、N日間未使用のセッションは自動削除または再キャプチャを要求する
- CookieのExpiry値も尊重するが、それより短い期限を設定可能にする

#### 1.3 メモリ内鍵のゼロ化
- 暗号化/復号化処理完了後、導出した鍵を`Buffer.fill(0)`でゼロ化する
- パスフレーズもメモリから速やかにクリアする

---

### Phase 2: 推奨改善（優先度: 中）

#### 2.1 Argon2idへの移行
- PBKDF2からArgon2idに移行する（GPUによるブルートフォース攻撃に強い）
- 推奨パラメータ: m=64MiB, t=2, p=1
- 既存のPBKDF2セッションは復号成功時に自動で新スキームに再暗号化する

#### 2.2 AAD（追加認証データ）の追加
- AES-GCM暗号化時にAADを使用する
- AADにはバージョン番号とセッションIDを含める
- これにより暗号文の誤関連付けや改ざんを防止する

#### 2.3 監査ログの実装
- セッションの保存/読み込み/削除をログに記録する
- 記録内容: ユーザーID、タイムスタンプ、IPアドレス（マスク済み）、操作結果
- ログは不変ストレージに保存し、管理者向けUIで閲覧可能にする

---

### Phase 3: 将来対応（優先度: 低）

#### 3.1 メタデータ暗号化
- index.jsonのドメイン名などの機密フィールドを暗号化する
- 顧客が使用しているサービスの推測を防止する

#### 3.2 Cloud Storage永続ストレージへの移行
- Cloud Runのエフェメラルストレージから永続ストレージに移行する
- IAMで最小権限を設定し、サービスアカウントのみアクセス可能にする

#### 3.3 MFAゲートの実装
- セッション使用時にMFA認証を要求する
- ターゲットサイトがMFAを使用していなくても、本サービス側でMFAを適用する

---

## 非機能要件

### パフォーマンス
- 鍵導出は250ms以内に完了すること
- レート制限によるレスポンス遅延は最大5秒

### 互換性
- 暗号文にバージョンプレフィックスを追加し、将来のスキーム変更に対応
- 既存セッションの自動マイグレーションをサポート

### セキュリティ
- パスフレーズや導出鍵をログ出力しない
- エラーメッセージから機密情報を漏洩しない
