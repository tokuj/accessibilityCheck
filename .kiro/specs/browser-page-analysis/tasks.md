# Implementation Plan

## Task 1: CDP接続管理サービスの実装

- [ ] 1.1 CDP接続サービスのコア機能を実装
  - Playwrightの`chromium.connectOverCDP()`を使用してChromeブラウザへの接続を確立する機能を作成
  - 接続エンドポイントのURL形式バリデーション（http://またはws://）を実装
  - ローカルホスト（127.0.0.1、localhost）以外への接続時にセキュリティ警告を返却する機能を実装
  - 接続タイムアウト（10秒）の設定と、タイムアウト時の適切なエラー返却を実装
  - 接続成功時にセッションIDを生成し、ブラウザインスタンスをメモリ内で管理
  - _Requirements: 1.1, 1.3, 1.4, 7.1, 7.2_

- [ ] 1.2 ページ一覧取得機能を実装
  - 接続中のブラウザから全てのコンテキストとページを取得する機能を作成
  - 各ページのID、タイトル、URL、ファビコンURLを抽出
  - chrome://やchrome-extension://などの内部ページを除外するフィルタリングを実装
  - ページが存在しない場合の空配列ハンドリングを実装
  - _Requirements: 1.2, 2.1, 2.3, 2.5_

- [ ] 1.3 切断処理とセッション管理を実装
  - `browser.disconnect()`を使用してCDP接続を切断し、ユーザーのブラウザを継続動作させる機能を実装
  - セッションIDに基づくブラウザインスタンスの取得機能を実装
  - 30分の非アクティブ後に自動切断するセッションタイムアウト機能を実装
  - 接続状態の確認機能（isConnected）を実装
  - _Requirements: 1.5, 7.5_

## Task 2: CDP接続APIエンドポイントの実装

- [ ] 2.1 (P) 接続APIエンドポイントを実装
  - POST /api/cdp/connect エンドポイントを作成
  - リクエストからエンドポイントURLを受け取り、CDPConnectionManagerを呼び出す
  - 接続成功時はsessionIdとページ一覧を返却、失敗時はエラー詳細を返却
  - 接続拒否（CONNECTION_REFUSED）、タイムアウト（TIMEOUT）、無効なエンドポイント（INVALID_ENDPOINT）のHTTPステータスコードを適切に設定
  - _Requirements: 1.1, 1.3, 1.4, 6.1_

- [ ] 2.2 (P) ページ一覧取得APIエンドポイントを実装
  - GET /api/cdp/pages エンドポイントを作成
  - クエリパラメータからsessionIdを取得し、ページ一覧を返却
  - 無効なsessionIdの場合は404エラーを返却
  - _Requirements: 1.2, 2.4_

- [ ] 2.3 (P) 切断APIエンドポイントを実装
  - POST /api/cdp/disconnect エンドポイントを作成
  - リクエストからsessionIdを受け取り、切断処理を実行
  - 切断成功時は成功レスポンス、失敗時はエラーレスポンスを返却
  - _Requirements: 1.5_

## Task 3: ブラウザページ分析サービスの実装

- [ ] 3.1 CDP接続ページの分析機能を実装
  - CDP接続で取得したPageオブジェクトに対してアクセシビリティ分析を実行する機能を作成
  - 使用可能なエンジン（axe-core、IBM、Alfa、QualWeb）を順次または並列で実行
  - 分析オプション（エンジン選択、WCAGレベル）を受け取り、適切に設定
  - 既存のanalyzeWithAxeEnhanced関数を再利用してaxe-core分析を実行
  - 分析結果を既存のAccessibilityReport形式で返却
  - _Requirements: 3.1, 3.3, 3.6_

- [ ] 3.2 進捗通知とスクリーンショット機能を実装
  - ProgressCallbackを使用して分析の進捗状況（現在実行中のエンジン名など）を通知する機能を実装
  - page.screenshot()を使用してページの現在状態のスクリーンショットを取得しレポートに含める
  - 各エンジンの実行時間を計測してレポートに含める
  - _Requirements: 3.2, 3.4_

- [ ] 3.3 ページナビゲーション検出機能を実装
  - page.on('framenavigated')イベントを監視して分析中のページ変更を検出
  - ページがナビゲーションやリロードで変更された場合に分析を中断
  - 「ページが変更されました。再度ページを選択してください」というエラーを返却
  - 分析完了後に注入したスクリプトをページから削除する処理を実装
  - _Requirements: 3.5, 7.4_

## Task 4: 分析APIエンドポイントの実装

- [ ] 4.1 分析実行APIエンドポイントを実装
  - POST /api/cdp/analyze エンドポイントを作成
  - sessionId、pageId、分析オプションをリクエストから取得
  - CDPConnectionManagerからPageオブジェクトを取得し、BrowserPageAnalyzerで分析を実行
  - 分析結果をAccessibilityReport形式で返却
  - セッションなし（404）、ページなし（404）、ページ変更（409）のエラーハンドリングを実装
  - _Requirements: 3.1, 3.3, 3.5_

- [ ] 4.2 SSEストリームによる進捗通知を実装
  - GET /api/cdp/analyze/stream エンドポイントを作成
  - Server-Sent Eventsを使用してリアルタイムで分析進捗を通知
  - 進捗イベント（step、total、stepName）を既存の形式で送信
  - 分析完了時にレポートを送信し、ストリームを終了
  - 接続切断時の適切なクリーンアップ処理を実装
  - _Requirements: 3.2_

## Task 5: フロントエンドモード切り替えUIの実装

- [ ] 5.1 分析モード選択コンポーネントを実装
  - 「URL入力」と「ブラウザ接続」の2つのモードを切り替えるUIを作成
  - MUI ToggleButtonGroupまたはTabsを使用してモード選択UIを実装
  - デフォルトで「URL入力」モードを選択状態にする
  - モード切り替え時に既存の分析結果がある場合、クリア確認ダイアログを表示
  - App.tsxに統合し、選択されたモードに応じて適切なコンポーネントを表示
  - _Requirements: 5.1, 5.3, 5.4, 5.5_

- [ ] 5.2 (P) CDP使い方ガイドコンポーネントを実装
  - OS別（Windows、macOS、Linux）のChrome起動コマンドを表示するUIを作成
  - MUI AccordionまたはTabsを使用してOS別の表示を切り替え
  - 各コマンドにコピーボタンを実装
  - ポート番号9222を使用した起動例を表示
  - リモートデバッグモードのセキュリティ上の注意事項（ローカル接続のみ推奨）を表示
  - ユーザーのOSを自動検出してデフォルト表示を切り替え
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

## Task 6: フロントエンドCDP接続UIの実装

- [ ] 6.1 ブラウザ接続パネルコンポーネントを実装
  - CDPエンドポイントURL入力フィールドを作成（デフォルト値: http://localhost:9222）
  - 接続ボタンと接続状態の表示を実装
  - 接続中のローディング状態を表示
  - 接続成功時にページセレクターを表示
  - 接続エラー時にエラーメッセージとガイドへのリンクを表示
  - CDPUsageGuideコンポーネントを統合して表示
  - _Requirements: 5.2, 4.3, 6.1, 6.3_

- [ ] 6.2 ページ選択パネルコンポーネントを実装
  - 接続中のブラウザのページ一覧をリスト形式で表示
  - 各ページのタイトル、URL、ファビコン（取得可能な場合）を表示
  - ページを選択できるラジオボタンまたはリストアイテムを実装
  - 一覧更新ボタンを実装し、クリック時に最新のページ一覧を再取得
  - ページが存在しない場合のメッセージ表示を実装
  - 選択したページで分析を開始するボタンを実装
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

## Task 7: フロントエンドAPI通信とエラーハンドリングの実装

- [ ] 7.1 CDP接続用APIサービスを実装
  - /api/cdp/connect、/api/cdp/pages、/api/cdp/disconnectへのAPI呼び出し関数を作成
  - 接続結果、ページ一覧、切断結果の型定義を作成
  - セッションIDの保持と管理機能を実装
  - _Requirements: 1.1, 1.2, 1.5_

- [ ] 7.2 (P) CDP分析用SSEストリーム接続を実装
  - /api/cdp/analyze/streamへのSSE接続を既存のSSEクライアントパターンに倣って実装
  - 進捗イベント、完了イベント、エラーイベントのハンドリングを実装
  - 接続切断時のリトライまたはエラー表示を実装
  - _Requirements: 3.2_

- [ ] 7.3 (P) エラーメッセージとリカバリーUIを実装
  - CDP接続エラー（CONNECTION_REFUSED、TIMEOUT、INVALID_ENDPOINT）に対応するエラーメッセージを定義
  - リモートデバッグモード未起動時のエラーにガイドへのリンクを含める
  - 接続切断時の再接続オプションを表示
  - ポート競合時の別ポート使用提案メッセージを表示
  - Chromeバージョン非対応時のサポート情報を表示
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

## Task 8: 統合とエンドツーエンド動作確認

- [ ] 8.1 バックエンドルーティングの統合
  - CDP接続関連のAPIルートをExpressアプリケーションに登録
  - 既存の分析APIと競合しないようルーティングを設定
  - CORSおよび認証ミドルウェアの適用を確認
  - _Requirements: 1.1, 1.2, 1.5_

- [ ] 8.2 フロントエンド統合と状態管理
  - App.tsxにAnalysisModeSelectorを統合
  - ブラウザ接続モード選択時にBrowserConnectPanelを表示
  - 分析結果を既存のReportSummaryコンポーネントで表示
  - ブラウザ接続モードでの分析後、既存のレポート表示フローに統合
  - _Requirements: 5.1, 3.3_

- [ ] 8.3 エンドツーエンド動作確認テスト
  - モード切り替えUI操作のE2Eテストを作成
  - CDP接続成功フローのテスト（接続→ページ選択→分析→レポート表示）
  - CDP接続エラー時のエラーメッセージ表示テスト
  - ページナビゲーション検出時のエラーハンドリングテスト
  - _Requirements: 5.1, 5.5, 6.2, 3.5_

## Task 9: ユニットテストと品質保証

- [ ]* 9.1 (P) CDPConnectionManagerのユニットテスト
  - connect()の正常接続、タイムアウト、接続拒否のテストケースを作成
  - getPages()のページ一覧取得、空配列返却のテストケースを作成
  - disconnect()の切断処理テストケースを作成
  - localhost制限とリモートホスト警告のテストケースを作成
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 7.1, 7.2_

- [ ]* 9.2 (P) BrowserPageAnalyzerのユニットテスト
  - analyzeConnectedPage()の正常分析テストケースを作成
  - ページナビゲーション検出とエラー返却のテストケースを作成
  - 各エンジン（axe-core、IBM、Alfa、QualWeb）の実行テストケースを作成
  - スクリーンショット取得のテストケースを作成
  - _Requirements: 3.1, 3.4, 3.5_

- [ ]* 9.3 (P) フロントエンドコンポーネントのユニットテスト
  - AnalysisModeSelectorのモード切り替えテストケースを作成
  - BrowserConnectPanelの接続フローテストケースを作成
  - PageSelectorPanelのページ選択テストケースを作成
  - CDPUsageGuideのOS別表示テストケースを作成
  - _Requirements: 5.1, 5.4, 5.5, 2.1, 2.2, 4.1_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 1.1, 2.1, 7.1, 8.1 |
| 1.2 | 1.2, 2.2, 7.1, 8.1 |
| 1.3 | 1.1, 2.1 |
| 1.4 | 1.1, 2.1 |
| 1.5 | 1.3, 2.3, 7.1, 8.1 |
| 2.1 | 1.2, 6.2 |
| 2.2 | 6.2 |
| 2.3 | 1.2, 6.2 |
| 2.4 | 2.2, 6.2 |
| 2.5 | 1.2, 6.2 |
| 3.1 | 3.1, 4.1 |
| 3.2 | 3.2, 4.2, 7.2 |
| 3.3 | 3.1, 4.1, 8.2 |
| 3.4 | 3.2 |
| 3.5 | 3.3, 4.1, 8.3 |
| 3.6 | 3.1 |
| 4.1 | 5.2 |
| 4.2 | 5.2 |
| 4.3 | 5.2, 6.1 |
| 4.4 | 5.2 |
| 5.1 | 5.1, 8.2, 8.3 |
| 5.2 | 6.1 |
| 5.3 | 5.1 |
| 5.4 | 5.1 |
| 5.5 | 5.1, 8.3 |
| 6.1 | 2.1, 6.1, 7.3 |
| 6.2 | 7.3, 8.3 |
| 6.3 | 6.1, 7.3 |
| 6.4 | 7.3 |
| 6.5 | 7.3 |
| 7.1 | 1.1 |
| 7.2 | 1.1 |
| 7.3 | - (設計上、Cookie/認証情報への直接アクセスはなし) |
| 7.4 | 3.3 |
| 7.5 | 1.3 |
