# Implementation Plan

## Tasks

- [x] 1. nginx設定ファイルの作成
- [x] 1.1 (P) SPA対応のnginx設定を作成する
  - ポート8080でリッスンするサーバー設定を記述する
  - SPAルーティング対応のため、すべてのパスをindex.htmlにフォールバックする設定を追加する
  - gzip圧縮を有効にし、テキスト系ファイルタイプを圧縮対象に設定する
  - 静的アセット（/assets/）に1年間の長期キャッシュを設定する
  - index.htmlにはno-cacheを設定し、常に最新版を取得させる
  - /healthエンドポイントでヘルスチェック応答を返す設定を追加する
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 7.1, 7.2_

- [x] 2. Dockerビルド構成の作成
- [x] 2.1 .dockerignoreファイルを作成する
  - node_modulesディレクトリを除外してビルドコンテキストを軽量化する
  - .gitディレクトリやテストファイルなど不要なファイルを除外する
  - _Requirements: 1.1_

- [x] 2.2 マルチステージDockerfileを作成する
  - ビルドステージでNode.js 22-alpineイメージを使用する
  - 依存関係をnpm ciでインストールし再現性を確保する
  - npm run buildでViteの本番ビルドを実行する
  - 本番ステージでnginx:alpine-slimイメージを使用する
  - nginx設定ファイルをコンテナにコピーする
  - ビルド成果物（dist/）をnginxの公開ディレクトリにコピーする
  - ポート8080を公開してCloud Run互換にする
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 2.1, 2.2, 2.3, 2.4_

- [x] 3. デプロイスクリプトの作成
- [x] 3.1 フロントエンド用デプロイスクリプトを作成する
  - GCPプロジェクト「itgproto」とリージョン「asia-northeast1」を設定する
  - エラー発生時に即座に終了するようset -eを設定する
  - Artifact Registryリポジトリの存在確認と作成を行う
  - gcloud CLIでDocker認証を設定する
  - linux/amd64プラットフォーム指定でDockerイメージをビルドする
  - ビルドしたイメージをArtifact Registryにプッシュする
  - Cloud Runにデプロイし、未認証アクセスを許可する
  - メモリ256MB、タイムアウト60秒、インスタンス数0-10を設定する
  - デプロイ成功時にフロントエンドURLとバックエンドURLを表示する
  - スクリプトに実行権限を付与する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8_

- [x] 4. ローカル環境での動作検証
- [x] 4.1 Dockerイメージのビルドと起動を検証する
  - frontendディレクトリでdocker buildを実行し、エラーなく完了することを確認する
  - ビルドしたイメージをdocker runで起動する
  - ポート8080へのアクセスでindex.htmlが返ることを確認する
  - /healthエンドポイントが200 OKを返すことを確認する
  - 存在しないパス（/test-route等）にアクセスしてSPAルーティングが動作することを確認する
  - _Requirements: 1.5, 1.6, 6.1, 7.1_

- [x] 5. Cloud Runへのデプロイ実行
- [x] 5.1 本番環境へデプロイを実行する
  - deploy-frontend.shスクリプトを実行する
  - Artifact Registryへのイメージプッシュが成功することを確認する
  - Cloud Runへのデプロイが完了しURLが表示されることを確認する
  - 表示されたURLにブラウザでアクセスしSPAが正常に表示されることを確認する
  - APIを使用した分析機能が動作することを確認する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 4.7, 5.1, 5.2, 5.3, 5.4_

- [x]* 6. 統合テストの実施
- [x] 6.1 (P) デプロイ後の動作確認テストを実施する
  - 複数のルートパス（/, /about等）にアクセスしてSPAルーティングを確認する
  - 静的アセットのレスポンスヘッダーでキャッシュ設定を確認する
  - gzip圧縮が有効になっていることをレスポンスヘッダーで確認する
  - フロントエンドからバックエンドAPIへのリクエストがCORSエラーなく成功することを確認する
  - **Playwrightブラウザテスト（tests/cloud-run-integration.spec.ts）で検証完了**
    - CORSエラー: 0件
    - APIレスポンス: 200 OK
  - _Requirements: 5.4, 6.1, 6.2, 6.3, 6.4, 7.2_

- [x] 7. バックエンドCORS設定の更新
- [x] 7.1 バックエンドをフロントエンドURL許可で再デプロイする
  - FRONTEND_ORIGIN環境変数にフロントエンドCloud Run URL（https://a11y-check-frontend-783872951114.asia-northeast1.run.app）を設定する
  - scripts/deploy.shを実行してバックエンドを再デプロイする
  - CORSヘッダー（access-control-allow-origin）が正しく返されることを確認する
  - フロントエンドからバックエンドAPIへのリクエストが成功することを確認する
  - _Requirements: 5.4_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1, 1.2, 1.3, 1.4, 1.5, 1.6 | 2.1, 2.2, 4.1 |
| 2.1, 2.2, 2.3, 2.4 | 2.2 |
| 3.1, 3.2, 3.3, 3.4, 3.5, 3.6 | 3.1, 5.1 |
| 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8 | 3.1, 5.1 |
| 5.1, 5.2, 5.3, 5.4 | 5.1, 6.1, 7.1 |
| 6.1, 6.2, 6.3, 6.4 | 1.1, 4.1, 6.1 |
| 7.1, 7.2 | 1.1, 4.1, 6.1 |
